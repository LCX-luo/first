# 使用 localStorage 实现留言板

要实现使用 `localStorage` 保存留言，需掌握数据存储、事件交互、函数封装等核心知识点，以下是完整笔记梳理：

## 一、 localStorage 核心操作（数据存储基础）

`localStorage` 是浏览器提供的本地存储 API，用于持久化存储字符串数据（页面刷新、关闭后数据不丢失），核心方法如下：

| 方法                               | 作用                                   | 注意事项                                                |
| ---------------------------------- | -------------------------------------- | ------------------------------------------------------- |
| `localStorage.setItem(key, value)` | 存储数据到本地                         | `value` 必须是**字符串**，若存储对象 / 数组需先转字符串 |
| `localStorage.getItem(key)`        | 根据键名获取存储的内容                 | 返回结果是字符串，需用 `JSON.parse()` 解析为对象 / 数组 |
| `localStorage.removeItem(key)`     | 根据键名删除指定数据                   | 仅删除指定键对应的数据，不影响其他存储                  |
| `localStorage.clear()`             | 清空当前域名下所有 `localStorage` 数据 | 谨慎使用，会删除所有存储内容，无法恢复                  |

## 二、 核心实现思路（整体流程）

1. **存储键名定义**：统一使用 `messages` 作为存储键，避免键名混乱。

2. 留言提交流程

   ：

   - 从表单获取用户输入的 “姓名” 和 “留言内容”；
   - 创建包含「姓名、内容、时间戳」的留言对象（时间戳用于排序和显示）；
   - 调用 `getMessages()` 获取本地已存的留言列表（若无则返回空数组）；
   - 将新留言对象添加到列表中，用 `JSON.stringify()` 转为字符串后，通过 `setItem()` 保存回本地；
   - 调用 `loadMessages()` 刷新页面显示，并清空表单输入框。

3. 页面加载流程：

   - 页面加载完成后（`DOMContentLoaded` 事件），自动调用 `loadMessages()`；
   - 从本地读取留言数据并解析，循环渲染到页面的留言容器中；
   - 根据留言数量控制 “清空全部” 按钮的显示 / 隐藏（有留言则显示，无则隐藏）。

## 三、 关键函数设计与用法（代码核心）

### 1. `getMessages()`：读取本地留言列表

#### 作用

从 `localStorage` 中读取所有留言，统一处理 “无数据” 场景，返回可直接使用的留言数组。

#### 代码

```javascript
function getMessages() {
    // 1. 读取本地存储的字符串（键为 messages）
    const messagesStr = localStorage.getItem('messages');
    // 2. 解析：有数据则转数组，无数据则返回空数组（避免后续遍历报错）
    return messagesStr ? JSON.parse(messagesStr) : [];
}
```

#### 用法

- 无需传参，直接调用即可获取留言数组，例如：

  ```javascript
  const allMessages = getMessages(); // 得到所有留言的数组
  console.log(allMessages.length); // 查看留言数量
  ```

### 2. `saveMessage(newMessage)`：保存新留言到本地

#### 作用

接收新留言对象，将其添加到现有留言列表中，并重新保存回 `localStorage`。

```javascript
function saveMessage(newMessage) {
    // 1. 先获取本地已有的留言列表（依赖 getMessages() 函数）
    const messages = getMessages();
    // 2. 将新留言对象添加到数组末尾
    messages.push(newMessage);
    // 3. 转为字符串后保存（localStorage 仅支持字符串）
    localStorage.setItem('messages', JSON.stringify(messages));
}
```

#### 用法

- 需传入一个 “留言对象”（包含

  ```
  name
  ```

  ```
  content
  ```

  ```
  timestamp
  ```

  属性），例如：

  ```javascript
  // 创建新留言对象
  const newMsg = {
      name: "张三",
      content: "这是一条新留言",
      timestamp: new Date().toISOString()
  };
  // 调用函数保存
  saveMessage(newMsg);
  ```

### 3. `loadMessages()`：加载并渲染留言到页面

#### 作用

读取本地留言，清空现有页面内容，按 “时间倒序”（最新在前）渲染所有留言，并控制 “清空按钮” 显示状态。

#### 代码

```javascript
function loadMessages() {
    // 1. 获取页面上的留言容器（需确保HTML中有id为 messages 的元素）
    const messagesContainer = document.getElementById('messages');
    // 2. 获取所有留言数组
    const messages = getMessages();

    // 3. 清空容器现有内容（避免重复渲染）
    messagesContainer.innerHTML = '';

    // 4. 倒序遍历留言，逐个渲染（reverse() 实现最新留言在前）
    messages.reverse().forEach(msg => {
        // 4.1 创建单个留言的容器元素
        const messageDiv = document.createElement('div');
        // 4.2 格式化时间（将ISO时间转为本地时间格式，如“2024/5/20 14:30:00”）
        const date = new Date(msg.timestamp);
        const formattedTime = date.toLocaleString();

        // 4.3 设置留言内容和样式
        messageDiv.innerHTML = `
            <strong>${msg.name}</strong> <small>${formattedTime}</small>
            <p>${msg.content}</p>
        `;
        messageDiv.style.borderBottom = "1px solid #ccc";
        messageDiv.style.marginBottom = "10px";
        messageDiv.style.paddingBottom = "10px";

        // 4.4 将留言添加到容器中
        messagesContainer.appendChild(messageDiv);
    });

    // 5. 控制“清空全部”按钮显示：有留言则显示，无则隐藏
    if (messages.length > 0) {
        document.getElementById('clearAllMessages').style.display = "block";
    } else {
        document.getElementById('clearAllMessages').style.display = "none";
    }
}
```

#### 用法

- 无需传参，直接调用即可刷新页面留言显示，例如：

  ```javascript
  // 页面加载后调用
  document.addEventListener('DOMContentLoaded', loadMessages);
  // 提交留言后调用（刷新显示）
  saveMessage(newMsg);
  loadMessages();
  ```

### 4. `clearAllMessages()`：清空所有留言

#### 作用

弹出确认对话框，询问用户是否删除所有留言，根据用户选择执行 “删除” 或 “取消” 操作。

#### 代码

```javascript
function clearAllMessages() {
    // 1. 弹出确认框（返回布尔值：确认则true，取消则false）
    const userConfirmed = confirm("确定要删除所有留言吗？此操作不可恢复。");
    
    // 2. 根据用户选择处理
    if (userConfirmed) {
        // 2.1 确认：删除本地存储的所有留言
        localStorage.removeItem('messages');
        // 2.2 隐藏“清空按钮”
        document.getElementById('clearAllMessages').style.display = "none";
        // 2.3 刷新页面（清空后显示空状态）
        loadMessages();
    } else {
        // 2.4 取消：不执行操作，可在控制台记录日志
        console.log("用户取消了删除操作");
    }
}
```

#### 用法

- 绑定到 “清空全部” 按钮的点击事件（需确保 HTML 按钮的

  ```
  onclick
  ```

  或事件监听指向该函数），例如：

  ```html
  <button id="clearAllMessages" onclick="clearAllMessages()">清空所有留言</button>
  ```

## 四、 事件处理与交互逻辑（用户操作响应）

### 1. 页面加载完成事件

- **作用**：确保 DOM 元素加载完成后再执行留言渲染，避免找不到容器元素。

- 代码

  ```javascript
  document.addEventListener('DOMContentLoaded', loadMessages);
  ```

- **原理**：`DOMContentLoaded` 事件在 HTML 解析完成、DOM 树构建后触发，早于 `window.onload`（需等待图片等资源加载），更适合初始化操作。

### 2. 表单提交事件

- **作用**：拦截表单默认提交行为，实现 “本地保存留言” 的自定义逻辑。

- 代码：

  ```javascript
  document.querySelector('.message-boardform form').addEventListener('submit', (e) => {
      // 1. 阻止表单默认提交（避免页面刷新）
      e.preventDefault();
  
      // 2. 获取表单输入值（需确保HTML中有id为 name 和 message 的输入框）
      const name = document.getElementById('name').value;
      const message = document.getElementById('message').value;
  
      // 3. 创建留言对象（包含时间戳，用于排序和显示）
      const newMessage = {
          name: name,
          content: message,
          timestamp: new Date().toISOString() // 标准化时间格式（如“2024-05-20T06:30:00.000Z”）
      };
  
      // 4. 保存留言并刷新显示
      saveMessage(newMessage);
      loadMessages();
  
      // 5. 清空表单（方便用户继续输入）
      document.getElementById('name').value = '';
      document.getElementById('message').value = '';
  });
  ```

- **关键**：`e.preventDefault()` 是核心，若无此句，表单会按默认方式提交（页面刷新，数据丢失）。

# 语法和函数总结

### 一、事件监听与初始化

#### 1. `document.addEventListener('DOMContentLoaded', loadMessages)`

- **`addEventListener`**：DOM 元素的事件监听方法，用于为元素绑定事件处理函数。
- **`'DOMContentLoaded'`**：事件类型，表示 HTML 文档解析完成、DOM 树构建完毕后触发（无需等待图片等资源加载）。
- **作用**：页面加载完成后自动执行 `loadMessages()` 函数，确保留言能在页面就绪后立即显示。

#### 2. 初始状态判断

```javascript
if (getMessages().length > 0) {
  document.getElementById('clearAllMessages').style.display = "block";
}
```

- **逻辑**：页面加载时检查是否有留言，若有则显示 “清空所有留言” 按钮。
- **`getMessages().length`**：通过 `getMessages()` 获取留言数组，用 `length` 属性判断是否有留言。
- **`style.display = "block"`**：通过 DOM 样式操作显示按钮（默认可能隐藏）。

### 二、表单提交事件处理

```javascript
document.querySelector('.message-boardform form').addEventListener('submit', (e) => { ... })
```

#### 1. 选择器与事件绑定

- `document.querySelector('.message-boardform form')`：
  - `querySelector` 用于根据 CSS 选择器查找页面中的元素（此处选择类名为 `message-boardform` 内的表单）。
  
- **`'submit'` 事件**：表单提交时触发的事件。

- **箭头函数 `(e) => { ... }`**：事件处理函数，`e` 是事件对象。

#### 2. 核心处理逻辑

- **`e.preventDefault()`**：阻止表单默认提交行为（默认会刷新页面，导致数据丢失）。

- **获取表单值**：

  ```javascript
  const name = document.getElementById('name').value;
  const message = document.getElementById('message').value;
  ```

  - `getElementById` 通过 ID 查找输入框元素，`value` 属性获取用户输入的内容。

- **创建留言对象**：

  ```javascript
  const newMessage = {
    name: name,
    content: message,
    timestamp: new Date().toISOString()
  };
  ```

  - 用对象存储留言信息，`timestamp` 字段记录时间（`toISOString()` 生成标准化时间字符串，便于排序）。

- **保存与刷新**：

  - `saveMessage(newMessage)`：将新留言保存到本地存储。
  - `loadMessages()`：重新加载并显示所有留言。
  - 清空表单：通过 `value = ''` 重置输入框，方便用户继续输入。

### 三、本地存储操作函数

#### 1. `getMessages()`：读取本地留言

```javascript
function getMessages() {
  const messagesStr = localStorage.getItem('messages');
  return messagesStr ? JSON.parse(messagesStr) : [];
}
```

- **`localStorage.getItem('messages')`**：从本地存储中读取键为 `messages` 的数据（返回字符串）。
- **三元运算符 `? :`**：判断是否有数据，有则用 `JSON.parse` 转换为数组，无则返回空数组（避免后续遍历报错）。

#### 2. `saveMessage(newMessage)`：保存新留言

```javascript
function saveMessage(newMessage) {
  const messages = getMessages(); // 获取现有留言
  messages.push(newMessage); // 添加新留言
  localStorage.setItem('messages', JSON.stringify(messages)); // 保存
}
```

- **`messages.push(newMessage)`**：数组的 `push` 方法，将新留言添加到数组末尾。
- **`JSON.stringify(messages)`**：将数组转换为字符串（`localStorage` 仅支持字符串存储）。
- **`localStorage.setItem(...)`**：将转换后的字符串存入本地存储。

### 四、留言渲染函数 `loadMessages()`

#### 1. 清空与获取数据

```javascript
const messagesContainer = document.getElementById('messages');
const messages = getMessages();
messagesContainer.innerHTML = ''; // 清空现有内容
```

- `getElementById('messages')` 获取页面上展示留言的容器元素。
- `innerHTML = ''` 清空容器，避免重复渲染旧留言。

#### 2. 遍历与渲染留言

```javascript
messages.reverse().forEach(msg => { ... })
```

- **`messages.reverse()`**：数组的 `reverse` 方法，颠倒数组顺序（让最新留言显示在前面）。

- `forEach(msg => { ... })`

  ：数组遍历方法，逐条处理留言：

  - **创建 DOM 元素**：`document.createElement('div')` 创建单个留言的容器。

  - 时间格式化：

    ```javascript
    const date = new Date(msg.timestamp);
    const formattedTime = date.toLocaleString();
    ```

    - `new Date(msg.timestamp)` 将时间字符串转为 `Date` 对象。
    - `toLocaleString()` 转换为本地时间格式（如 `2024/9/18 15:30:00`），提升可读性。

  - 设置内容与样式：

    ```javascript
    messageDiv.innerHTML = `
      <strong>${msg.name}</strong> <small>${formattedTime}</small>
      <p>${msg.content}</p>
    `;
    ```

    - **模板字符串**（```包裹）：支持换行和变量嵌入（`${变量}`），比传统字符串拼接更简洁。
    - 行内样式设置：通过 `style` 属性添加边框、边距等样式，分隔留言。

  - **添加到页面**：`messagesContainer.appendChild(messageDiv)` 将单个留言添加到容器中。

### 五、清空留言函数 `clearAllMessages()

```javascript
function clearAllMessages() {
  const userConfirmed = confirm("确定要删除所有留言吗？此操作不可恢复。");
  if (userConfirmed) {
    localStorage.removeItem('messages'); // 删除本地存储
    document.getElementById('clearAllMessages').style.display = "none"; // 隐藏按钮
    loadMessages(); // 刷新显示
  } else {
    console.log("用户取消了删除操作");
  }
}
```

- **`confirm(...)`**：弹出确认对话框，返回布尔值（用户点 “确定” 为 `true`，“取消” 为 `false`）。
- **`localStorage.removeItem('messages')`**：删除本地存储中键为 `messages` 的数据。
- 逻辑：用户确认后清空数据并刷新页面，取消则不执行操作。
